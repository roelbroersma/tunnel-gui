{% extends 'new-base.html' %}
{% block title %}Tunnel info{% endblock %}
{% block content %}
	<style>
        ul {
            list-style-type: none;
        }
	</style>
	<h3 class="mb-5">Tunnel</h3>
	<div class="row g-5" style="overflow-y: auto">
		<div class="py-5 text-center">
			<p class="lead">Current Device ID is "{{ device_id }}"</p>
		</div>
		<div class="col-12">
			<p>One device needs to be the <b>Master</b> and be accessible from outside (public IP or forwards a port on
				your router).<br>Do you want this device to be the Master?</p>
			<ul id="deviceType">
				<li>
					<input id="deviceType-0" name="deviceType" type="radio" value="master" checked="">
					<label for="deviceType-0">This device is the master</label>
				</li>
				<li>
					<input id="deviceType-1" name="deviceType" type="radio" value="notMaster">
					<label for="deviceType-1">This device is <b>NOT</b> master</label>
				</li>
			</ul>
		</div>

{#		<form method="POST" action="{{ url_for('tunnel') }}" id="masterForm">#}
		<form method="POST" id="masterForm">
			<div class="row g-3">
				<div class="col-12 mt-0 {% if tunnel_master_form.tunnel_type.errors %}was-validated{% endif %}">
					{{ tunnel_master_form.tunnel_type.label }}
					{{ tunnel_master_form.tunnel_type() }}
					<br>
					{% for err in tunnel_master_form.tunnel_type.errors %}
						<div class="invalid-feedback">
							{{ err }}
						</div>
					{% endfor %}
				</div>

				<div class="col-12">
					{{ tunnel_master_form.public_ip_or_ddns_hostname.label }}
					{{ tunnel_master_form.public_ip_or_ddns_hostname() }}
					<br>
					<div class=" {% if tunnel_master_form.public_ip_or_ddns_hostname.errors %}was-validated{% endif %}">
						{% for err in tunnel_master_form.public_ip_or_ddns_hostname.errors %}
							<div class="invalid-feedback">
								{{ err }}
							</div>
						{% endfor %}
					</div>
				</div>

				<div class="col-12 {% if tunnel_master_form.tunnel_port.errors %}was-validated{% endif %}">
					{{ tunnel_master_form.tunnel_port.label }}
					<br>
					{{ tunnel_master_form.tunnel_port() }}
					<br>
					{% for err in tunnel_master_form.tunnel_port.errors %}
						<div class="invalid-feedback">
							{{ err }}
						</div>
					{% endfor %}
				</div>

				<div class="col-12 {% if tunnel_master_form.protocol.errors %}was-validated{% endif %}">
					{{ tunnel_master_form.protocol.label }}
					{{ tunnel_master_form.protocol() }}
					<br>
					{% for err in tunnel_master_form.protocol.errors %}
						<div class="invalid-feedback">
							{{ err }}
						</div>
					{% endfor %}
				</div>

				<div id="clientIDsWrapper" class="col-12 mt-0 plus-sign {% if tunnel_master_form.client_ids.errors %}was-validated{% endif %}">
					{{ tunnel_master_form.client_ids.label }}
					<br>
					{{ tunnel_master_form.client_ids() }}
					<input id="client-ids-0" type="text" value="" class="mb-2">
					<i class='bx bx-plus'></i>
					<br>
					<div class="additional-inputs"></div>
					{% for err in tunnel_master_form.client_ids.errors %}
						<div class="invalid-feedback">
							{{ err }}
						</div>
					{% endfor %}
				</div>
			</div>



			<div class="col-12 {% if tunnel_master_form.mdns.errors %}was-validated{% endif %}">
				{{ tunnel_master_form.mdns() }}
				{{ tunnel_master_form.mdns.label }}
				<br>
				{% for err in tunnel_master_form.mdns.errors %}
					<div class="invalid-feedback">
						{{ err }}
					</div>
				{% endfor %}
			</div>

			<div class="col-12 {% if tunnel_master_form.pimd.errors %}was-validated{% endif %}">
				{{ tunnel_master_form.pimd() }}
				{{ tunnel_master_form.pimd.label }}
				<br>
				{% for err in tunnel_master_form.pimd.errors %}
					<div class="invalid-feedback">
						{{ err }}
					</div>
				{% endfor %}
			</div>

			<button class="w-100 btn btn-primary btn-lg" type="submit">Save</button>
		</form>

		<form method="POST" action="{{ url_for('tunnel') }}" id="notMasterForm">
			NOT MASTER FORM
			<button class="w-100 btn btn-primary btn-lg" type="submit">Save</button>
		</form>
	</div>


	<script>
        let masterFormContainer = document.getElementById("masterForm");
        masterFormContainer.style.display = "none";
        let notMasterFormContainer = document.getElementById("notMasterForm");
        notMasterFormContainer.style.display = "none";

        let deviceTypeMasterRadiobutton = document.getElementById("deviceType-0");
        let deviceTypeNotMasterRadiobutton = document.getElementById("deviceType-1");
        deviceTypeMasterRadiobutton.onclick = function () {
            let masterFormContainer = document.getElementById("masterForm");
            masterFormContainer.style.display = "block";
            let notMasterFormContainer = document.getElementById("notMasterForm");
            notMasterFormContainer.style.display = "none";
        }
        deviceTypeNotMasterRadiobutton.onclick = function () {
            let masterFormContainer = document.getElementById("masterForm");
            masterFormContainer.style.display = "none";
            let notMasterFormContainer = document.getElementById("notMasterForm");
            notMasterFormContainer.style.display = "block";
        }

        if (deviceTypeMasterRadiobutton.checked === true) {
            let masterFormContainer = document.getElementById("masterForm");
            masterFormContainer.style.display = "block";
        }
        if (deviceTypeNotMasterRadiobutton.checked === true) {
            let notMasterFormContainer = document.getElementById("notMasterForm");
            notMasterFormContainer.style.display = "block";
        }

        function beforeSubmit(event) {
	        let clientIDsInput = document.getElementById('client_ids');
            let clientIDInputsList = document.getElementById('clientIDsWrapper').getElementsByTagName('input');
            clientIDInputsList = [...clientIDInputsList].slice(1);

	        concattedClientIDs = clientIDInputsList.reduce(function(acc, val) {
	            let newID = val.value.trim();
	            if (!newID)
	                return acc;
	            if (!acc)
	                return newID;
	            return acc + ';' + newID;
	        }, '');
            clientIDsInput.value = concattedClientIDs;
        }

        const form = document.getElementById('masterForm');
        form.addEventListener('submit', beforeSubmit);

        const plusElement = document.getElementsByClassName('bx-plus')[0];
        plusElement.onclick = function() {
            const additionalInputsWrapper = document.getElementsByClassName('additional-inputs')[0];
            const newInput = document.createElement('input');
            newInput.type="text";
            newInput.classList.add("mb-2");
            const brElemenet = document.createElement('br');
            additionalInputsWrapper.appendChild(newInput);
            additionalInputsWrapper.appendChild(brElemenet);
        };
        {#const#}
        // <input class="add-more-items" id="client_ids" name="client_ids" type="text" value="">



	</script>
{% endblock %}
